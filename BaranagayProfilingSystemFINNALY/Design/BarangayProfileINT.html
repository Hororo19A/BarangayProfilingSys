<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Barangay Profile System</title>
    <link href="{{ url_for('static', filename='barangaypic.png') }}" rel="icon" type="image/png">
    <style>
        /* -------- Global Styles -------- */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: Arial, sans-serif; }
        body { display: flex; min-height: 100vh; background: linear-gradient(135deg, #d0f0ea, #b2dfdb); line-height: 1.5; }

        /* Sidebar */
        .sidebar {
            width: 240px;
            background: #00796b;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 25px;
            height: 100vh;
            position: sticky;
            top: 0;
            overflow-y: auto;
            box-shadow: 2px 0 8px rgba(0,0,0,0.2);
        }
        .sidebar img {
            width: 110px;
            height: 110px;
            border-radius: 50%;
            margin-bottom: 20px;
            border: 2px solid #004d40;
        }
        .sidebar h2 { font-size: 18px; margin-bottom: 25px; text-align: center; color: white; }
        .sidebar button {
            width: 90%;
            background: #004d40;
            color: white;
            border: none;
            padding: 14px;
            margin: 8px 0;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: 0.2s;
        }
        .sidebar button.active { background: #26a69a; }
        .sidebar button.logout { background: #e74c3c; margin-top: auto; margin-bottom: 25px; }
        .sidebar button:hover { opacity: 0.9; }

        /* Content */
        .content { flex-grow: 1; padding: 25px; overflow-y: auto; max-height: 100vh; }
        h1 { font-size: 32px; margin-bottom: 25px; color: #004d40; }
        h2 { font-size: 26px; margin-bottom: 12px; color: #004d40; }

        form input, form select, form button { margin: 6px 0; padding: 10px; width: 100%; border-radius: 10px; border: 1px solid #ccc; font-size: 15px; }
        button { cursor: pointer; }
        button.btn-green { background: #00796b; color: white; border: none; padding: 10px 14px; border-radius: 10px; font-size: 15px; }
        button.btn-orange { background: #26a69a; color: white; border: none; padding: 10px 14px; border-radius: 10px; font-size: 15px; }
        button.btn-red { background: #e74c3c; color: white; border: none; padding: 10px 14px; border-radius: 10px; font-size: 15px; }
        button:hover { opacity: 0.9; }

        .dashboard-cards { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 25px; }
        .dashboard-card {
            flex: 1 1 200px;
            background: #004d40;
            color: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 4px 16px rgba(0,0,0,0.25);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .dashboard-card:hover { transform: translateY(-4px); box-shadow: 0 10px 24px rgba(0,0,0,0.35); }
        .dashboard-card h3 { font-size: 20px; margin-bottom: 10px; }
        .dashboard-card p { font-size: 24px; margin: 0; }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 14px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        th { background: #00796b; color: white; font-weight: 500; }
        tr:nth-child(even) { background: #f1f1f1; }
        tr:hover { background: #c8e6c9; }

        .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .search-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; gap: 8px; flex-wrap: wrap; }
        .search-container h2 { margin: 0; flex: 1; }
        .search-input { padding: 8px 10px; border-radius: 10px; border: 1px solid #ccc; height: 36px; font-size: 14px; }
        .search-btn { padding: 8px 14px; border: none; border-radius: 10px; background: #00796b; color: white; cursor: pointer; height: 36px; font-size: 14px; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 12px; width: 400px; max-width: 90%; position: relative; box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
        .close { position: absolute; top: 10px; right: 14px; cursor: pointer; font-weight: bold; font-size: 18px; }

        .actions { display: flex; gap: 6px; justify-content: center; flex-direction: column; }
        .actions button { width: 120px; padding: 6px; font-size: 13px; margin-bottom: 4px; }

        #editForm { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        #editForm button { grid-column: span 2; }

        .flash-message span { background: #c8e6c9; color: #004d40; padding: 6px 12px; border-radius: 6px; display: inline-block; margin-right: 10px; }

        .settings-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; }
        .settings-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.25); }
        .settings-box h2 { color: #00796b; font-size: 22px; margin-bottom: 14px; border-bottom: 2px solid #ccc; padding-bottom: 4px; }
        .settings-box label { display: block; margin-top: 10px; margin-bottom: 4px; font-weight: 500; }
        .settings-box input[type="text"], .settings-box input[type="password"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 10px; margin-bottom: 10px; }

        .panel { background:white; padding:20px; border-radius:12px; box-shadow:0 4px 16px rgba(0,0,0,0.25); margin-bottom:20px; }

        .household-form { display: flex; flex-direction: column; gap: 12px; }
        .household-form select { padding: 10px; border-radius: 10px; border: 1px solid #ccc; font-size: 15px; height: 140px; }
        .household-form button { width: 180px; align-self: flex-start; }
    </style>
</head>
<body>
<div class="sidebar">
    <img alt="Logo" src="{{ url_for('static', filename='barangaypic.png') }}">
    <h2>Barangay Profiling</h2>
    <button class="{% if active_page=='dashboard' %}active{% endif %}" onclick="window.location.href='/user/dashboard'">
        Dashboard
    </button>
    <button class="{% if active_page=='residents' %}active{% endif %}"
            onclick="window.location.href='/user/manage_residents'">Manage Residents
    </button>
    <button class="{% if active_page=='households' %}active{% endif %}"
            onclick="window.location.href='/user/manage_households'">Manage Households
    </button>
    <button class="{% if active_page=='settings' %}active{% endif %}" onclick="window.location.href='/user/settings'">
        Settings
    </button>
    <button class="logout" onclick="window.location.href='/logout'">Logout</button>
</div>

<div class="content">

    <!-- DASHBOARD -->
    {% if active_page=='dashboard' %}
    <h1>Welcome {{ user['FirstName'] }} {{ user['LastName'] }}!</h1>

    <!-- Dashboard Cards -->
    <div class="dashboard-cards">
        <div class="dashboard-card">
            <h3>Total Residents</h3>
            <p>{{ total_residents }}</p>
        </div>
        <div class="dashboard-card">
            <h3>Total Households</h3>
            <p>{{ total_households }}</p>
        </div>
        <div class="dashboard-card">
            <h3>Total Zones</h3>
            <p>{{ all_zones_count }}</p>
        </div>
    </div>

    <!-- Zones Table -->
    <div class="search-container" style="margin-top:30px;">
        <h2>Zones Population</h2>
        <form method="get" style="display:flex; gap:8px;">
            <input class="search-input" name="search_zone" placeholder="Search Zone" type="text"
                   value="{{ search_zone }}">
            <button class="search-btn" type="submit">Search</button>
        </form>
    </div>
    <table>
        <thead>
        <tr>
            <th>Zone</th>
            <th>Population</th>
        </tr>
        </thead>
        <tbody>
        {% if zones %}
        {% for zone, count in zones.items() %}
        <tr>
            <td>{{ zone }}</td>
            <td>{{ count }}</td>
        </tr>
        {% endfor %}
        {% elif search_zone %}
        <tr>
            <td colspan="2">No zone found for "{{ search_zone }}"</td>
        </tr>
        {% endif %}
        </tbody>
    </table>

    <!-- Households Table -->
    <div class="search-container" style="margin-top:30px;">
        <h2>Households</h2>
        <form method="get" style="display:flex; gap:8px;">
            <input class="search-input" name="search_household" placeholder="Search Household ID" type="text"
                   value="{{ search_household }}">
            <button class="search-btn" type="submit">Search</button>
        </form>
    </div>
    <table>
        <thead>
        <tr>
            <th>Household ID</th>
            <th>Members</th>
        </tr>
        </thead>
        <tbody>
        {% if households %}
        {% for hh_id, members in households.items() %}
        <tr>
            <td>{{ hh_id }}</td>
            <td>{{ members|join(', ') }}</td>
        </tr>
        {% endfor %}
        {% elif search_household %}
        <tr>
            <td colspan="2">No household ID found for "{{ search_household }}"</td>
        </tr>
        {% endif %}
        </tbody>
    </table>

    <!-- Residents Table -->
    <div class="search-container" style="margin-top:30px;">
        <h2>Residents</h2>
        <form method="get" style="display:flex; gap:8px;">
            <input class="search-input" name="search_resident" placeholder="Search Resident" type="text"
                   value="{{ search_resident }}">
            <button class="search-btn" type="submit">Search</button>
        </form>
    </div>
    <table>
        <thead>
        <tr>
            <th>RefID</th>
            <th>Full Name</th>
        </tr>
        </thead>
        <tbody>
        {% if residents %}
        {% for r in residents %}
        <tr>
            <td>{{ r.RefId }}</td>
            <td>{{ r.Name }}{% if r.MI %} {{ r.MI }}{% endif %} {{ r.LastName }}</td>
        </tr>
        {% endfor %}
        {% elif search_resident %}
        <tr>
            <td colspan="2">No resident found for "{{ search_resident }}"</td>
        </tr>
        {% endif %}
        </tbody>
    </table>
    {% endif %}


    <!-- RESIDENTS -->
    {% if active_page=='residents' %}
    <h1 style="text-align:center; margin-bottom:25px;">Manage Residents</h1>

    <!-- Add Resident Panel -->
    <div class="panel" style="max-width:1150px; margin:0 auto 20px auto; padding:20px;">
        <h2 style="margin-bottom:15px;">Add New Resident</h2>
        <form class="form-grid" id="addResidentForm" method="post"
              style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px; align-items:end;">
            <input name="name" placeholder="First Name" required type="text">
            <input name="mi" placeholder="Middle Name" required type="text">
            <input name="lname" placeholder="Last Name" required type="text">
            <input name="zone" placeholder="Zone" required type="text">
            <input name="birthday" placeholder="Birthday" required type="date">
            <input min="0" name="age" placeholder="Age" required type="number">
            <select name="sex" required>
                <option disabled selected value="">Select Sex</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
            </select>
            <input name="address" placeholder="Address" required type="text">
            <select name="civil_status" required>
                <option disabled selected value="">Select Civil Status</option>
                <option value="Single">Single</option>
                <option value="Married">Married</option>
                <option value="Widowed">Widowed</option>
            </select>
            <input name="occupation" placeholder="Occupation" required type="text">
            <input name="nationality" placeholder="Nationality" required type="text">

            <!-- Add Button same size as Nationality input -->
            <button class="btn-green" style="padding:8px; width:100%;" type="submit">Add Resident</button>
        </form>
    </div>

    <!-- Search & Flash Messages -->
    <div class="search-container"
         style="max-width:1150px; margin:0 auto 20px auto; display:flex; justify-content:space-between; align-items:center;">

        <!-- Flash Messages -->
        <div class="flash-message" id="flash-message1">
            {% with messages = get_flashed_messages() %}
            {% if messages %}
            {% for message in messages %}
            <span style="color:green; font-weight:bold;">{{ message }}</span>
            {% endfor %}
            {% endif %}
            {% endwith %}
        </div>

        <!-- Search Bar -->
        <form method="get" style="display:flex; gap:8px;">
            <input class="search-input" name="search" placeholder="Search Ref ID / Name / Last Name"
                   style="padding:8px 12px;" type="text" value="{{ search_query }}">
            <button class="search-btn" style="padding:8px 14px;" type="submit">Search</button>
        </form>
    </div>

    <script>
        // Auto-hide flash messages after 2 seconds
        window.addEventListener('DOMContentLoaded', () => {
            const flash = document.getElementById('flash-message');
            if(flash && flash.textContent.trim() !== "") {
                setTimeout(() => {
                    flash.style.transition = "opacity 0.5s ease";
                    flash.style.opacity = 0;
                }, 2000); // 2 seconds
            }
        });
    </script>

    <!-- Residents Table -->
    <div style="max-width:1150px; margin:0 auto; overflow-x:auto;">
        <table style="width:100%; border-collapse:collapse;">
            <thead>
            <tr>
                <th>Ref ID</th>
                <th>First Name</th>
                <th>Middle Name</th>
                <th>Last Name</th>
                <th>Birthday</th>
                <th>Age</th>
                <th>Sex</th>
                <th>Address</th>
                <th>Civil Status</th>
                <th>Occupation</th>
                <th>Nationality</th>
                <th>Zone</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for r in residents %}
            <tr>
                <td>{{ r['RefId'] }}</td>
                <td>{{ r['Name'] }}</td>
                <td>{{ r['MI'] }}</td>
                <td>{{ r['LastName'] }}</td>
                <td>{{ r['Birthday'] }}</td>
                <td>{{ r['Age'] }}</td>
                <td>{{ r['Sex'] }}</td>
                <td>{{ r['Address'] }}</td>
                <td>{{ r['CivilStatus'] }}</td>
                <td>{{ r['Occupation'] }}</td>
                <td>{{ r['Nationality'] }}</td>
                <td>{{ r['Zone'] }}</td>
                <td class="actions" style="display:flex; gap:6px; flex-direction:column; align-items:center;">
                    <button class="btn-orange" onclick="openEditModal('{{ r['RefId'] }}')" type="button">Update</button>
                    <form action="{{ url_for('user.delete_resident', ref_id=r['RefId']) }}" method="post"
                          onsubmit="return confirm('Are you sure you want to delete this resident?');">
                        <button class="btn-red" type="submit">Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Edit Resident Modal -->
    <div class="modal" id="editModal"
         style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center;">
        <div class="modal-content"
             style="background:white; padding:20px; border-radius:8px; max-width:700px; width:95%;">
        <span class="close" onclick="closeEditModal()"
              style="cursor:pointer; float:right; font-weight:bold;">X</span>
            <h3 style="margin-bottom:15px;">Edit Resident</h3>
            <form id="editForm" method="post"
                  style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px;">
                <input id="edit_name" name="name" placeholder="First Name" required type="text">
                <input id="edit_mi" name="mi" placeholder="Middle Name" required type="text">
                <input id="edit_lname" name="lname" placeholder="Last Name" required type="text">
                <input id="edit_zone" name="zone" placeholder="Zone" required type="text">
                <input id="edit_birthday" name="birthday" placeholder="Birthday" required type="date">
                <input id="edit_age" min="0" name="age" placeholder="Age" required type="number">
                <select id="edit_sex" name="sex" required>
                    <option value="">Select Sex</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                </select>
                <input id="edit_address" name="address" placeholder="Address" required type="text">
                <select id="edit_civil_status" name="civil_status" required>
                    <option value="">Select Civil Status</option>
                    <option value="Single">Single</option>
                    <option value="Married">Married</option>
                    <option value="Widowed">Widowed</option>
                </select>
                <input id="edit_occupation" name="occupation" placeholder="Occupation" required type="text">
                <input id="edit_nationality" name="nationality" placeholder="Nationality" required type="text">
                <div style="grid-column: 1 / -1; text-align:right;">
                    <button class="btn-orange" type="submit">Update Resident</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const residentsList = [
            {% for r in residents %}
            {
                RefId: "{{ r['RefId'] }}",
                Name: "{{ r['Name'] }}",
                MI: "{{ r['MI'] }}",
                LastName: "{{ r['LastName'] }}",
                Birthday: "{{ r['Birthday'] }}",
                Age: "{{ r['Age'] }}",
                Sex: "{{ r['Sex'] }}",
                Address: "{{ r['Address'] }}",
                CivilStatus: "{{ r['CivilStatus'] }}",
                Occupation: "{{ r['Occupation'] }}",
                Nationality: "{{ r['Nationality'] }}",
                Zone: "{{ r['Zone'] }}"
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];

        function openEditModal(refId) {
            const modal = document.getElementById('editModal');
            const resident = residentsList.find(r => r.RefId === refId);
            if(resident) {
                document.getElementById('edit_name').value = resident.Name;
                document.getElementById('edit_mi').value = resident.MI;
                document.getElementById('edit_lname').value = resident.LastName;
                document.getElementById('edit_zone').value = resident.Zone;
                document.getElementById('edit_birthday').value = resident.Birthday;
                document.getElementById('edit_age').value = resident.Age;
                document.getElementById('edit_sex').value = resident.Sex;
                document.getElementById('edit_address').value = resident.Address;

                const civilSelect = document.getElementById('edit_civil_status');
                for (let i = 0; i < civilSelect.options.length; i++) {
                    civilSelect.options[i].selected = civilSelect.options[i].value.trim() === resident.CivilStatus.trim();
                }

                document.getElementById('edit_occupation').value = resident.Occupation;
                document.getElementById('edit_nationality').value = resident.Nationality;
                document.getElementById('editForm').action = '/user/update_resident/' + refId;
                modal.style.display = 'flex';
            }
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        window.onclick = function(event) {
            if(event.target == document.getElementById('editModal')) closeEditModal();
        }
    </script>
    {% endif %}


    <!-- HOUSEHOLDS -->
    {% if active_page == 'households' %}
    <style>
        /* THEME-ALIGNED BUTTON ENHANCEMENTS */ .btn-green, .btn-blue, .btn-red, .btn-gray { width: 170px; padding: 10px 0; border-radius: 10px; font-weight: 500; font-size: 0.9rem; cursor: pointer; transition: transform 0.15s ease, box-shadow 0.15s ease, opacity 0.15s ease; } .btn-green:hover, .btn-blue:hover, .btn-red:hover, .btn-gray:hover { transform: translateY(-1px); box-shadow: 0 6px 14px rgba(0,0,0,0.12); opacity: 0.95; } .btn-green:active, .btn-blue:active, .btn-red:active, .btn-gray:active { transform: translateY(0); box-shadow: 0 3px 8px rgba(0,0,0,0.15); } /* SUBTLE COLOR TUNING TO MATCH DASHBOARD */ .btn-green { background:#10b981; color:#fff; border:none; } .btn-blue { background:#6ee7b7; color:#065f46; border:none; } .btn-red { background:#ef4444; color:#fff; border:none; } .btn-gray { background:#9ca3af; color:#111827; border:none; } /* DISABLE FORM BUTTON SHRINKING */ form { margin:0; }
    </style>
    <h1 style="text-align:center; margin-bottom:25px;">Manage Households</h1>

    <!-- CREATE HOUSEHOLD PANEL -->
    <div class="panel" style="max-width:1150px; margin:0 auto 20px; padding:16px;"><h2>Create New Household</h2>
        <form action="{{ url_for('user.create_household') }}" method="post"> {% set available_residents = residents |
            selectattr('HouseholdID', 'equalto', 'None') | list %} {% if available_residents|length == 0 %} <p
                    style="color:#9ca3af; font-style:italic;">No available residents.</p> {% else %} <select multiple
                                                                                                             name="members[]"
                                                                                                             required
                                                                                                             style="width:100%; min-height:130px; padding:10px;">
                {% for r in available_residents %}
                <option value="{{ r.RefId }}">{{ r.Name }} {{ r.LastName }}</option>
                {% endfor %} </select>
            <div style="text-align:right; margin-top:12px;">
                <button class="btn-green" style="font-weight:500;" type="submit">Create Household</button>
            </div>
            {% endif %}
        </form>
    </div>

    <!-- FLASH + SEARCH -->
    <div style="max-width:1150px; margin:0 auto 20px; display:flex; justify-content:space-between; align-items:center; gap:12px;">
        <div id="1flash-message"
             style="background:#d1fae5; color:#065f46; padding:8px 12px; border-radius:6px; font-size:0.85em;"> {% with
            messages = get_flashed_messages() %} {% if messages %} {% for m in messages %}{{ m }}{% endfor %} {% endif
            %} {% endwith %}
        </div>
        <form method="get" style="display:flex; gap:8px;"><input name="search_hh" placeholder="Search Household ID"
                                                                 style="padding:8px 12px;" value="{{ search_hh }}">
            <button class="search-btn" type="submit">Search</button>
        </form>
    </div>

    <!-- HOUSEHOLD TABLE -->
    <table style="width:100%; max-width:1150px; margin:0 auto; border-collapse:collapse;">
        <thead>
        <tr>
            <th style="text-align:left; padding:12px;">Household ID</th>
            <th style="text-align:left; padding:12px;">Members</th>
            <th style="text-align:center; padding:12px;">Actions</th>
        </tr>
        </thead>
        <tbody> {% for hh_id, members in households.items() %}
        <tr>
            <td style="padding:12px;">{{ hh_id }}</td>
            <td style="padding:12px;">{{ members | join(', ') }}</td>
            <td style="padding:12px;">
                <div class="action-btn-group"
                     style="display:flex; flex-direction:column; gap:12px; align-items:center;">
                    <style>
                        .action-btn-group > form { width:170px; margin:0; } .action-btn-group > button { width:170px; }
                    </style>

                    <!-- ADD MEMBERS -->
                    <button class="btn-green" onclick="openAddModal('{{ hh_id }}')" style="font-weight:500;">Add
                        Members
                    </button>

                    <!-- MOVE RESIDENT -->
                    <button class="btn-blue" onclick="openMoveModal('{{ hh_id }}')" style="font-weight:500;">Move
                        Resident
                    </button>

                    <!-- DELETE HOUSEHOLD -->
                    <form action="{{ url_for('user.remove_household', hh_id=hh_id) }}" method="post"
                          onsubmit="return confirm('Delete this household?');"
                          style="margin:0; padding:0; display:flex; justify-content:center;">
                        <button class="btn-red" style="width:170px; margin:0;">Delete</button>
                    </form>
                </div>
            </td>
        </tr>

        <!-- ADD MEMBERS MODAL -->
        <div class="modal" id="add-modal-{{ hh_id }}">
            <div class="modal-content"><h3>Add Members to {{ hh_id }}</h3> {% set free_residents = residents |
                selectattr('HouseholdID', 'equalto', 'None') | list %}
                <form action="{{ url_for('user.add_to_household', hh_id=hh_id) }}" method="post"> {% if
                    free_residents|length == 0 %} <p style="color:#9ca3af;">No residents available.</p>
                    <button class="btn-gray" onclick="closeAddModal('{{ hh_id }}')" type="button">Close</button>
                    {% else %} <select multiple name="new_members" required style="width:100%; min-height:140px;"> {%
                        for r in free_residents %}
                        <option value="{{ r.RefId }}">{{ r.Name }} {{ r.LastName }}</option>
                        {% endfor %} </select>
                    <div style="margin-top:12px; display:flex; justify-content:center; gap:10px;">
                        <button class="btn-green" type="submit">Add</button>
                        <button class="btn-gray" onclick="closeAddModal('{{ hh_id }}')" type="button">Cancel</button>
                    </div>
                    {% endif %}
                </form>
            </div>
        </div>

        <!-- MOVE RESIDENT MODAL -->
        <div class="modal" id="move-modal-{{ hh_id }}">
            <div class="modal-content">
                <h3>Move Resident ({{ hh_id }})</h3>

                <!-- Flash message -->
                <div id="flash-message" style="margin-bottom:12px; color:red; font-weight:bold;">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                    {% for category, message in messages %}
                    {% if category == 'danger' %}
                    <span>{{ message }}</span>
                    {% endif %}
                    {% endfor %}
                    {% endif %}
                    {% endwith %}
                </div>
                <form action="{{ url_for('user.move_resident') }}" method="post">
                    <input name="from_hh" type="hidden" value="{{ hh_id }}">
                    <label>Resident</label>
                    <select name="resident_id" required style="width:100%; margin-bottom:12px;">
                        {% for r in residents %}
                        {% if r.HouseholdID == hh_id %}
                        <option value="{{ r.RefId }}">{{ r.Name }} {{ r.LastName }}</option>
                        {% endif %}
                        {% endfor %}
                    </select>

                    <label>Move To</label>
                    <select name="to_hh" required style="width:100%; margin-bottom:14px;">
                        {% for target in households.keys() %}
                        {% if target != hh_id %}
                        <option value="{{ target }}">{{ target }}</option>
                        {% endif %}
                        {% endfor %}
                    </select>

                    <div style="display:flex; justify-content:center; gap:10px;">
                        <button class="btn-green" type="submit">Move</button>
                        <button class="btn-gray" onclick="closeMoveModal('{{ hh_id }}')" type="button">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
        {% endfor %}
        </tbody>
    </table>
    <script>
        function openAddModal(id){document.getElementById('add-modal-'+id).style.display='flex';} function closeAddModal(id){document.getElementById('add-modal-'+id).style.display='none';} function openMoveModal(id){document.getElementById('move-modal-'+id).style.display='flex';} function closeMoveModal(id){document.getElementById('move-modal-'+id).style.display='none';} window.addEventListener('DOMContentLoaded',()=>{ const f=document.getElementById('flash-message'); if(f && f.textContent.trim()!==''){ setTimeout(()=>{f.style.opacity=0;},2000); } });
    </script>
    {% endif %}


    <!-- ================= SETTINGS ================= -->
    {% if active_page == 'settings' %}

    <h1 style="text-align:center; margin-bottom:40px;">Settings</h1>

    <div style="
    max-width:1200px;
    margin:0 auto 40px auto;
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(340px, 1fr));
    gap:24px;
">

        <!-- ================= CURRENT ACCOUNT ================= -->
        <div style="
        background:#ffffff;
        padding:22px;
        border-radius:10px;
        box-shadow:0 4px 12px rgba(0,0,0,0.18);
    ">
            <h2>Current Account</h2>
            <p style="font-size:0.85em; color:#555; margin-bottom:14px;">
                This section displays your current account information.
            </p>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                <div>
                    <label>First Name</label>
                    <div class="info-box">{{ user.FirstName }}</div>
                </div>

                <div>
                    <label>Middle Name</label>
                    <div class="info-box">{{ user.MiddleName }}</div>
                </div>

                <div>
                    <label>Last Name</label>
                    <div class="info-box">{{ user.LastName }}</div>
                </div>

                <div>
                    <label>Username</label>
                    <div class="info-box">{{ user.Username }}</div>
                </div>

                <div style="grid-column:span 2; position:relative;">
                    <label>Password</label>
                    <input class="info-box" id="currentPasswordInput" readonly style="padding-right:40px;"
                           type="password" value="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    <span onclick="toggleCurrentPassword()" style="
                    position:absolute;
                    right:12px;
                    top:29px;
                    cursor:pointer;
                    font-size:18px;
                ">üëÅ</span>
                </div>
            </div>
        </div>

        <!-- ================= UPDATE ACCOUNT ================= -->
        <div style="
        background:#f8fafc;
        padding:22px;
        border-radius:10px;
        box-shadow:0 4px 12px rgba(0,0,0,0.18);
    ">
            <h2 style="margin-bottom:10px;">Update Account</h2>

            <!-- SHOW FLASH ONLY FOR UPDATE -->
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            <div id="settings-flash" style="margin-bottom:12px;">
                {% for category, message in messages %}
                {% if category in ['success', 'error'] %}
                <div style="
                    background: {% if category == 'success' %}#d1fae5{% else %}#fee2e2{% endif %};
                    color: {% if category == 'success' %}#065f46{% else %}#991b1b{% endif %};
                    padding:8px 12px;
                    border-radius:6px;
                    font-size:0.85em;
                    margin-bottom:6px;
                ">
                    {{ message }}
                </div>
                {% endif %}
                {% endfor %}
            </div>
            {% endif %}
            {% endwith %}

            <form action="{{ url_for('user.settings') }}" method="post">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                    <div>
                        <label>First Name</label>
                        <input name="first_name" required>
                    </div>

                    <div>
                        <label>Middle Name</label>
                        <input name="middle_name" required>
                    </div>

                    <div>
                        <label>Last Name</label>
                        <input name="last_name" required>
                    </div>

                    <div>
                        <label>Username</label>
                        <input name="username" required>
                    </div>

                    <div style="grid-column:span 2;">
                        <label>New Password</label>
                        <input name="password" required type="password">
                    </div>

                    <div style="grid-column:span 2;">
                        <label>Confirm Password</label>
                        <input name="confirm_password" required type="password">
                    </div>
                </div>

                <button class="btn-green" style="margin-top:16px; width:100%;">
                    Update Information
                </button>
            </form>
        </div>

        <!-- ================= SYSTEM OVERVIEW ================= -->
        <div style="
        background:#f1f5f9;
        padding:22px;
        border-radius:10px;
        box-shadow:0 4px 12px rgba(0,0,0,0.18);
    ">
            <h2>System Overview</h2>
            <p style="font-size:0.9em; margin-bottom:12px; text-align:center;">
                The Barangay Profile System manages residents, households, and barangay records
                securely and efficiently, helping officials maintain accurate and transparent data.
            </p>
            <hr style="margin:12px 0;">
            <p style="font-size:0.9em;">
                Version: <strong>{{ system_info.version }}</strong><br>
                Database: <strong>{{ system_info.database }}</strong><br>
                Framework: <strong>{{ system_info.framework }}</strong><br>
                Last Update: <strong>{{ system_info.last_update }}</strong>
            </p>
        </div>

    </div>

    <script>
        let passwordFetched = false;

        function toggleCurrentPassword() {
            const input = document.getElementById('currentPasswordInput');
            if (!passwordFetched) {
                fetch('/user/get_current_password')
                    .then(res => res.json())
                    .then(data => {
                        input.value = data.password;
                        input.type = 'text';
                        passwordFetched = true;
                    });
            } else {
                input.type = input.type === 'password' ? 'text' : 'password';
            }
        }

        // Auto-hide update flash after 2 seconds
        window.addEventListener('DOMContentLoaded', () => {
            const flash = document.getElementById('settings-flash');
            if (flash) {
                setTimeout(() => {
                    flash.style.display = 'none';
                }, 2000);
            }
        });
    </script>

    <style>
        label {
            font-size:0.85em;
            font-weight:600;
            color:#444;
        }
        input {
            width:100%;
            padding:8px;
            border-radius:6px;
            border:1px solid #ccc;
            font-size:0.9em;
        }
        .info-box {
            background:#e5e7eb;
            padding:8px;
            border-radius:6px;
            font-size:0.9em;
        }
    </style>

    {% endif %}


</div>

<script>
    function openEditModal(refId) {
        const modal = document.getElementById('editModal');
        const resident = residentsList.find(r => r.RefId === refId);
        if(resident) {
            document.getElementById('edit_name').value = resident.Name;
            document.getElementById('edit_mi').value = resident.MI;
            document.getElementById('edit_lname').value = resident.LastName;
            document.getElementById('edit_zone').value = resident.Zone;
            document.getElementById('edit_birthday').value = resident.Birthday;
            document.getElementById('edit_age').value = resident.Age;
            document.getElementById('edit_sex').value = resident.Sex;
            document.getElementById('edit_address').value = resident.Address;
            document.getElementById('edit_civil_status').value = resident.CivilStatus;
            document.getElementById('edit_occupation').value = resident.Occupation;
            document.getElementById('edit_nationality').value = resident.Nationality;
            document.getElementById('editForm').action = '/user/update_resident/' + refId;
            modal.style.display = 'flex';
        }
    }
    function closeEditModal() { document.getElementById('editModal').style.display = 'none'; }
    window.onclick = function(event) { if(event.target == document.getElementById('editModal')) closeEditModal(); }
</script>
</body>
</html>
