<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Barangay Profile System</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='barangaypic.png') }}">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: Arial, sans-serif; }
        body { display: flex; min-height: 100vh; background: linear-gradient(135deg, #d0f0ea, #b2dfdb); line-height: 1.5; }

        /* Sidebar */
        .sidebar {
            width: 240px;
            background: #00796b;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 25px;
            height: 100vh;
            position: sticky;
            top: 0;
            overflow-y: auto;
            box-shadow: 2px 0 8px rgba(0,0,0,0.2);
        }
        .sidebar img {
            width: 110px;
            height: 110px;
            border-radius: 50%;
            margin-bottom: 20px;
            border: 2px solid #004d40;
        }
        .sidebar h2 {
            font-size: 18px;
            margin-bottom: 25px;
            text-align: center;
            color: white;
        }
        .sidebar button {
            width: 90%;
            background: #004d40;
            color: white;
            border: none;
            padding: 14px;
            margin: 8px 0;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: 0.2s;
        }
        .sidebar button.active { background: #26a69a; }
        .sidebar button.logout {
            background: #e74c3c;
            margin-top: auto;
            margin-bottom: 25px;
        }
        .sidebar button:hover { opacity: 0.9; }

        /* Content */
        .content {
            flex-grow: 1;
            padding: 25px;
            overflow-y: auto;
            max-height: 100vh;
        }
        h1 { font-size: 32px; margin-bottom: 25px; color: #004d40; }
        h2 { font-size: 26px; margin-bottom: 20px; color: #004d40; }

        form input, form select, form button {
            margin: 6px 0;
            padding: 10px;
            width: 100%;
            border-radius: 10px;
            border: 1px solid #ccc;
            font-size: 15px;
        }
        button { cursor: pointer; }
        button.btn-green { background: #00796b; color: white; border: none; padding: 10px 14px; border-radius: 10px; font-size: 15px; }
        button.btn-orange { background: #26a69a; color: white; border: none; padding: 10px 14px; border-radius: 10px; font-size: 15px; }
        button.btn-red { background: #e74c3c; color: white; border: none; padding: 10px 14px; border-radius: 10px; font-size: 15px; }
        button:hover { opacity: 0.9; }

        /* Dashboard cards */
        .dashboard-cards {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 25px;
        }
        .dashboard-card {
            flex: 1 1 200px;
            background: #004d40;
            color: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 4px 16px rgba(0,0,0,0.25);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .dashboard-card:hover { transform: translateY(-4px); box-shadow: 0 10px 24px rgba(0,0,0,0.35); }
        .dashboard-card h3 { font-size: 20px; margin-bottom: 10px; }
        .dashboard-card p { font-size: 24px; margin: 0; }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 14px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        th { background: #00796b; color: white; font-weight: 500; }
        tr:nth-child(even) { background: #f1f1f1; }
        tr:hover { background: #c8e6c9; }

        .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px; margin-bottom: 12px; }
        .search-container { display: flex; flex-wrap: wrap; justify-content: flex-end; gap: 6px; margin-bottom: 15px; }
        .search-input { padding: 8px 10px; border-radius: 10px; border: 1px solid #ccc; height: 36px; font-size: 14px; }
        .search-btn { padding: 8px 14px; border: none; border-radius: 10px; background: #00796b; color: white; cursor: pointer; height: 36px; font-size: 14px; }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 12px;
            width: 400px;
            max-width: 90%;
            position: relative;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        .close { position: absolute; top: 10px; right: 14px; cursor: pointer; font-weight: bold; font-size: 18px; }

        .actions {
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: center;
        }
        .actions button { width: 80px; padding: 6px; font-size: 13px; }

        /* Edit Modal Two-column layout */
        #editForm { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        #editForm button { grid-column: span 2; }

        /* Flash message */
        .flash-message span {
            background: #c8e6c9;
            color: #004d40;
            padding: 6px 12px;
            border-radius: 6px;
            display: inline-block;
            margin-right: 10px;
        }

        .box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.25);
            margin-bottom: 20px;
        }
        .settings-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; }
        .settings-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.25);
        }
        .settings-box h2 {
            color: #00796b;
            font-size: 22px;
            margin-bottom: 14px;
            border-bottom: 2px solid #ccc;
            padding-bottom: 4px;
        }
        .settings-box label {
            display: block;
            margin-top: 10px;
            margin-bottom: 4px;
            font-weight: 500;
        }
        .settings-box input[type="text"], .settings-box input[type="password"], .settings-box input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        .logo-preview {
            width: 100%;
            text-align: center;
            margin-bottom: 10px;
        }
        .logo-preview img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 2px solid #00796b;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <img src="{{ url_for('static', filename='barangaypic.png') }}" alt="Logo">
        <h2>Barangay Profiling</h2>
        <button class="{% if active_page=='dashboard' %}active{% endif %}" onclick="window.location.href='/user/dashboard'">Dashboard</button>
        <button class="{% if active_page=='residents' %}active{% endif %}" onclick="window.location.href='/user/manage_residents'">Manage Residents</button>
        <button class="{% if active_page=='households' %}active{% endif %}" onclick="window.location.href='/user/manage_households'">Manage Households</button>
        <button class="{% if active_page=='settings' %}active{% endif %}" onclick="window.location.href='/user/settings'">Settings</button>
        <button class="logout" onclick="window.location.href='/logout'">Logout</button>
    </div>

    <div class="content">

        <!-- Dashboard -->
        {% if active_page=='dashboard' %}
        <h1>Welcome {{ user['FirstName'] }} {{ user['MiddleName'] }} {{ user['LastName'] }}</h1>
        <div class="dashboard-cards">
            <div class="dashboard-card">
                <h3>Total Residents</h3>
                <p>{{ total_residents }}</p>
            </div>
            <div class="dashboard-card">
                <h3>Total Households</h3>
                <p>{{ total_households }}</p>
            </div>
        </div>
        <!-- Zones Table -->
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h2>Zones Population</h2>
            <form method="get" action="{{ url_for('user.dashboard') }}" style="display:flex; gap:8px;">
                <input type="text" name="search_zone" placeholder="Search Zone" class="search-input" value="{{ search_zone }}">
                <button type="submit" class="search-btn">Search</button>
            </form>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Zone</th>
                    <th>Population</th>
                </tr>
            </thead>
            <tbody>
                {% if zones %}
                    {% for zone, population in zones.items() %}
                        <tr><td>{{ zone }}</td><td>{{ population }}</td></tr>
                    {% endfor %}
                {% else %}
                    <tr><td colspan="2">No results found.</td></tr>
                {% endif %}
            </tbody>
        </table>

        <!-- Households Table -->
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h2>Households</h2>
            <form method="get" action="{{ url_for('user.dashboard') }}" style="display:flex; gap:8px;">
                <input type="text" name="search_household" placeholder="Search Household ID" class="search-input" value="{{ search_household }}">
                <button type="submit" class="search-btn">Search</button>
            </form>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Household ID</th>
                    <th>Members</th>
                </tr>
            </thead>
            <tbody>
                {% if households %}
                    {% for hh_id, members in households.items() %}
                        <tr><td>{{ hh_id }}</td><td>{{ members|join(', ') }}</td></tr>
                    {% endfor %}
                {% else %}
                    <tr><td colspan="2">No results found.</td></tr>
                {% endif %}
            </tbody>
        </table>
        {% endif %}

        <!-- Residents Management -->
        {% if active_page=='residents' %}
        <h1>Manage Residents</h1>
        <form method="post" class="form-grid">
            <input type="text" name="Name" placeholder="First Name" required>
            <input type="text" name="MI" placeholder="Middle Name">
            <input type="text" name="LastName" placeholder="Last Name">
            <input type="text" name="Zone" placeholder="Zone" required>
            <input type="date" name="Birthday" placeholder="Birthday">
            <input type="number" name="Age" placeholder="Age">
            <select name="Sex" required>
                <option value="" disabled selected>Select Sex</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
            </select>
            <input type="text" name="Address" placeholder="Address">
            <select name="CivilStatus">
                <option value="" disabled selected>Select Civil Status</option>
                <option value="Single">Single</option>
                <option value="Married">Married</option>
                <option value="Widowed">Widowed</option>
            </select>
            <input type="text" name="Occupation" placeholder="Occupation">
            <input type="text" name="Nationality" placeholder="Nationality">
            <button type="submit" class="btn-green">Add Resident</button>
        </form>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <div class="flash-message">
                {% with messages = get_flashed_messages() %}
                    {% if messages %}
                        {% for message in messages %}
                            <span>{{ message }}</span>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
            </div>
            <form method="get" style="display:flex; gap:8px;">
                <input type="text" name="search" value="{{ search_query }}" placeholder="Search Ref ID / Name / Last Name" class="search-input">
                <button type="submit" class="search-btn">Search</button>
            </form>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Ref ID</th><th>First Name</th><th>Middle Name</th><th>Last Name</th><th>Birthday</th>
                    <th>Age</th><th>Sex</th><th>Address</th><th>Civil Status</th><th>Occupation</th>
                    <th>Nationality</th><th>Zone</th><th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for r in residents %}
                <tr>
                    <td>{{ r['RefId'] }}</td>
                    <td>{{ r['Name'] }}</td>
                    <td>{{ r['MI'] }}</td>
                    <td>{{ r['LastName'] }}</td>
                    <td>{{ r['Birthday'] }}</td>
                    <td>{{ r['Age'] }}</td>
                    <td>{{ r['Sex'] }}</td>
                    <td>{{ r['Address'] }}</td>
                    <td>{{ r['CivilStatus'] }}</td>
                    <td>{{ r['Occupation'] }}</td>
                    <td>{{ r['Nationality'] }}</td>
                    <td>{{ r['Zone'] }}</td>
                    <td class="actions">
                        <button class="btn-orange" type="button" onclick="openEditModal('{{ r['RefId'] }}')">Update</button>
                        <form method="post" action="{{ url_for('user.delete_resident', ref_id=r['RefId']) }}" onsubmit="return confirm('Are you sure?');" style="display:inline-block;">
                            <button class="btn-red">Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div id="editModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeEditModal()">X</span>
                <h3>Edit Resident</h3>
                <form id="editForm" method="post">
                    <input type="text" name="Name" id="edit_name" placeholder="First Name" required>
                    <input type="text" name="MI" id="edit_mi" placeholder="Middle Name">
                    <input type="text" name="LastName" id="edit_lname" placeholder="Last Name">
                    <input type="text" name="Zone" id="edit_zone" placeholder="Zone" required>
                    <input type="date" name="Birthday" id="edit_birthday" placeholder="Birthday">
                    <input type="number" name="Age" id="edit_age" placeholder="Age">
                    <select name="Sex" id="edit_sex" required>
                        <option value="">Select Sex</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                    <input type="text" name="Address" id="edit_address" placeholder="Address">
                    <select name="CivilStatus" id="edit_civil_status">
                        <option value="">Select Civil Status</option>
                        <option value="Single">Single</option>
                        <option value="Married">Married</option>
                        <option value="Widowed">Widowed</option>
                    </select>
                    <input type="text" name="Occupation" id="edit_occupation" placeholder="Occupation">
                    <input type="text" name="Nationality" id="edit_nationality" placeholder="Nationality">
                    <button type="submit" class="btn-orange">Update Resident</button>
                </form>
            </div>
        </div>
        {% endif %}

        <!-- Households Management -->
        {% if active_page=='households' %}
        <h1>Manage Households</h1>
        <div style="margin-bottom:15px;">
            <form method="get" style="display:flex; gap:8px;">
                <input type="text" name="search" value="{{ search_query }}" placeholder="Search Household ID" class="search-input">
                <button type="submit" class="search-btn">Search</button>
            </form>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Household ID</th>
                    <th>Residents</th>
                </tr>
            </thead>
            <tbody>
                {% if households %}
                    {% for hh_id, members in households.items() %}
                        <tr>
                            <td>{{ hh_id }}</td>
                            <td>{{ members|join(', ') }}</td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="2">No results found.</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
        {% endif %}

        <!-- Settings -->
        {% if active_page=='settings' %}
        <h1>Settings</h1>
        <div class="settings-container">

            <!-- Logo Update -->
            <div class="settings-box">
                <h2>System Logo</h2>
                <div class="logo-preview">
                    <img src="{{ url_for('static', filename='barangaypic.png') }}">
                </div>
                <form method="post" enctype="multipart/form-data" action="{{ url_for('user.update_logo') }}">
                    <input type="file" name="logo" required>
                    <button type="submit" class="btn-green">Update Logo</button>
                </form>
            </div>

            <!-- Account Update -->
            <div class="settings-box">
                <h2>Account Info</h2>
                <form method="post" action="{{ url_for('user.update_account') }}">
                    <label>First Name</label>
                    <input type="text" name="FirstName" value="{{ user['FirstName'] }}" required>

                    <label>Middle Initial</label>
                    <input type="text" name="MiddleName" value="{{ user['MiddleName'] }}">

                    <label>Last Name</label>
                    <input type="text" name="LastName" value="{{ user['LastName'] }}" required>

                    <label>Username</label>
                    <input type="text" name="Username" value="{{ user['Username'] }}" required>

                    <label>Password</label>
                    <input type="password" name="Password" placeholder="Enter new password if changing">

                    <button type="submit" class="btn-green">Update Account</button>
                </form>
            </div>

        </div>
        {% endif %}

    </div>

    <script>
        function openEditModal(refId) {
            const modal = document.getElementById("editModal");
            modal.style.display = "flex";

            fetch(`/user/get_resident/${refId}`)
                .then(res => res.json())
                .then(data => {
                    document.getElementById("edit_name").value = data.Name || "";
                    document.getElementById("edit_mi").value = data.MI || "";
                    document.getElementById("edit_lname").value = data.LastName || "";
                    document.getElementById("edit_zone").value = data.Zone || "";
                    document.getElementById("edit_birthday").value = data.Birthday || "";
                    document.getElementById("edit_age").value = data.Age || "";
                    document.getElementById("edit_sex").value = data.Sex || "";
                    document.getElementById("edit_address").value = data.Address || "";
                    document.getElementById("edit_civil_status").value = data.CivilStatus || "";
                    document.getElementById("edit_occupation").value = data.Occupation || "";
                    document.getElementById("edit_nationality").value = data.Nationality || "";
                });

            document.getElementById("editForm").action = `/user/update_resident/${refId}`;
        }

        function closeEditModal() {
            document.getElementById("editModal").style.display = "none";
        }

        setTimeout(() => {
            const flash = document.querySelectorAll('.flash-message span');
            flash.forEach(f => f.style.display = 'none');
        }, 2000);
    </script>
</body>
</html>
