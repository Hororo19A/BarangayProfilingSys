<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Panel</title>
<link rel="icon" type="image/png" href="{{ url_for('static', filename='barangaypic.png') }}">
<style>
/* ---------------- Global Styles ---------------- */
* { box-sizing: border-box; margin:0; padding:0; font-family:'Segoe UI',sans-serif; }
body { display:flex; min-height:100vh; background:#f0f2f5; }

/* ---------------- Sidebar ---------------- */
.sidebar {
    width:220px; background:#0041c7; color:white; display:flex; flex-direction:column;
    align-items:center; padding-top:20px; height:100vh; position:sticky; top:0; overflow-y:auto;
    box-shadow:2px 0 8px rgba(0,0,0,0.1);
}
.sidebar img { width:100px; height:100px; border-radius:50%; margin-bottom:15px; color:white; }
.sidebar h2 { font-size:16px; margin-bottom:20px; text-align:center; color:white; }
.sidebar button {
    width:85%; background:#0160C9; color:white; border:none; padding:8px; margin:5px 0;
    border-radius:5px; font-size:13px; cursor:pointer; transition:0.2s;
}
.sidebar button.active { background:#28a745; }
.sidebar button.logout { background:#e74c3c; margin-top:auto; margin-bottom:20px; }
.sidebar button:hover { opacity:0.9; }

/* ---------------- Content ---------------- */
.content { flex-grow:1; padding:20px; overflow-y:auto; max-height:100vh; }

/* ---------------- Titles ---------------- */
h1 { font-size:28px; margin-bottom:20px; color:#333; }
h2 { font-size:22px; margin-bottom:15px; color:#333; }

/* ---------------- Forms & Buttons ---------------- */
form input, form select, form button { margin:3px 0; padding:6px; width:100%; border-radius:5px; border:1px solid #ccc; }
button { cursor:pointer; }
button.btn-green { background:#28a745; color:white; border:none; padding:8px 12px; border-radius:5px; }
button.btn-orange { background:#f39c12; color:white; border:none; padding:8px 12px; border-radius:5px; }
button.btn-red { background:#e74c3c; color:white; border:none; padding:8px 12px; border-radius:5px; }
button:hover { opacity:0.9; }

/* ---------------- Dashboard Cards ---------------- */
.dashboard-cards { display:flex; gap:20px; flex-wrap:wrap; margin-bottom:30px; }
.dashboard-card {
    flex:1 1 200px; background:#2980b9; color:white; border-radius:12px; padding:20px;
    text-align:center; font-weight:bold; box-shadow:0 4px 12px rgba(0,0,0,0.12);
    transition: transform 0.2s, box-shadow 0.2s;
}
.dashboard-card:hover { transform:translateY(-4px); box-shadow:0 8px 20px rgba(0,0,0,0.18); }
.dashboard-card h3 { font-size:18px; margin-bottom:10px; }
.dashboard-card p { font-size:24px; margin:0; }

/* ---------------- Tables ---------------- */
table { width:100%; border-collapse:collapse; font-size:13px; background:white; border-radius:8px; overflow:hidden; box-shadow:0 2px 5px rgba(0,0,0,0.1); margin-bottom:20px; }
th, td { border:1px solid #ddd; padding:10px; text-align:center; }
th { background:#2980b9; color:white; font-weight:500; }
tr:nth-child(even) { background:#f8f9fa; }
tr:hover { background:#e1f0ff; }

/* ---------------- Forms & Search ---------------- */
.form-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap:10px; margin-bottom:20px; }
.search-container { display:flex; justify-content:flex-end; margin-bottom:15px; gap:5px; }
.search-input { padding:6px 8px; border-radius:5px; border:1px solid #ccc; height:32px; }
.search-btn { padding:6px 12px; border:none; border-radius:5px; background:#28a745; color:white; cursor:pointer; height:32px; }

/* ---------------- Modal ---------------- */
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
.modal-content { background:white; padding:20px; border-radius:8px; width:420px; position:relative; }
.close { position:absolute; top:5px; right:10px; cursor:pointer; font-weight:bold; }

/* ---------------- Actions ---------------- */
.actions { display:flex; flex-direction:column; gap:3px; align-items:center; }
.actions button { width:80px; }

/* ---------------- Boxes ---------------- */
.box { background:white; padding:15px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); margin-bottom:20px; }

/* ---------------- Settings ---------------- */
.settings-container { display:grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap:20px; }
.settings-box { background:white; padding:20px; border-radius:10px; box-shadow:0 3px 10px rgba(0,0,0,0.08); }
.settings-box h2 { color:#0041c7; font-size:20px; margin-bottom:12px; border-bottom:2px solid #ccc; padding-bottom:5px; }
.settings-box label { display:block; margin-top:8px; margin-bottom:3px; font-weight:500; }
.settings-box input[type="text"], .settings-box input[type="password"], .settings-box input[type="file"] { width:100%; padding:8px; border:1px solid #ccc; border-radius:5px; margin-bottom:10px; }
.logo-preview { width:100%; text-align:center; margin-bottom:10px; }
.logo-preview img { width:120px; height:120px; border-radius:50%; border:2px solid #0041c7; }
.settings-box ul { list-style:none; padding-left:0; line-height:1.6; color:#444; margin-top:10px; }
.settings-box p { margin-top:15px; color:#555; font-size:14px; }
</style>
</head>
<body>

<!-- ---------------- Sidebar ---------------- -->
<div class="sidebar">
    <img src="{{ url_for('static', filename='barangaypic.png') }}" alt="Logo">
    <h2>Barangay Profiling</h2>
    <button class="{% if active_page=='dashboard' %}active{% endif %}" onclick="window.location.href='/admin/dashboard'">Dashboard</button>
    <button class="{% if active_page=='residents' %}active{% endif %}" onclick="window.location.href='/admin/manage_residents'">Manage Residents</button>
    <button class="{% if active_page=='households' %}active{% endif %}" onclick="window.location.href='/admin/manage_households'">Manage Households</button>
    <button class="{% if active_page=='settings' %}active{% endif %}" onclick="window.location.href='/admin/settings'">Settings</button>
    <button class="logout" onclick="window.location.href='/logout'">Logout</button>
</div>

<div class="content">

<!-- ================= Dashboard ================= -->
{% if active_page=='dashboard' %}
<h1>Admin Dashboard</h1>
<div class="dashboard-cards">
    <div class="dashboard-card">
        <h3>Total Residents</h3>
        <p>{{ total_residents }}</p>
    </div>
    <div class="dashboard-card">
        <h3>Total Households</h3>
        <p>{{ total_households }}</p>
    </div>
</div>

<!-- Zones -->
<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
    <h2>Zones Population</h2>
    <form method="get">
        <input type="text" name="search_zone" value="{{ request.args.get('search_zone','') }}" placeholder="Search Zone" class="search-input">
        <button type="submit" class="search-btn">Search</button>
    </form>
</div>
<table>
<thead><tr><th>Zone</th><th>Population</th></tr></thead>
<tbody>
{% for zone, population in zones.items() if not request.args.get('search_zone') or request.args.get('search_zone').lower() in zone.lower() %}
<tr><td>{{ zone }}</td><td>{{ population }}</td></tr>
{% endfor %}
</tbody>
</table>

<!-- Households -->
<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
    <h2>Households</h2>
    <form method="get">
        <input type="text" name="search_hh" value="{{ request.args.get('search_hh','') }}" placeholder="Search Household ID" class="search-input">
        <button type="submit" class="search-btn">Search</button>
    </form>
</div>
<table>
<thead><tr><th>Household ID</th><th>Members</th></tr></thead>
<tbody>
{% for hh_id, members in households.items() if not request.args.get('search_hh') or request.args.get('search_hh').lower() in hh_id.lower() %}
<tr><td>{{ hh_id }}</td><td>{{ members|join(', ') }}</td></tr>
{% endfor %}
</tbody>
</table>
{% endif %}

<!-- ================= Manage Residents ================= -->
{% if active_page=='residents' %}
<h1>Manage Residents</h1>
<form method="post" class="form-grid">
    <input type="text" name="name" placeholder="Name" required>
    <input type="text" name="mi" placeholder="Middle Initial">
    <input type="text" name="lname" placeholder="Last Name">
    <input type="text" name="zone" placeholder="Zone" required>
    <input type="date" name="birthday" placeholder="Birthday">
    <input type="number" name="age" placeholder="Age">
    <select name="sex" required>
        <option value="" disabled selected>Select Sex</option>
        <option value="Male">Male</option>
        <option value="Female">Female</option>
    </select>
    <input type="text" name="address" placeholder="Address">
    <select name="civil_status">
        <option value="" disabled selected>Select Civil Status</option>
        <option value="Single">Single</option>
        <option value="Married">Married</option>
        <option value="Widowed">Widowed</option>
    </select>
    <input type="text" name="occupation" placeholder="Occupation">
    <input type="text" name="nationality" placeholder="Nationality">
    <button type="submit" class="btn-green">Add Resident</button>
</form>

<div class="search-container">
<form method="get">
    <input type="text" name="search" value="{{ request.args.get('search','') }}" placeholder="Search Ref ID / Name / Last Name" class="search-input">
    <button type="submit" class="search-btn">Search</button>
</form>
</div>

<table>
<thead>
<tr>
<th>Ref ID</th><th>Name</th><th>MI</th><th>Last Name</th><th>Birthday</th><th>Age</th>
<th>Sex</th><th>Address</th><th>Civil Status</th><th>Occupation</th><th>Nationality</th><th>Zone</th><th>Actions</th>
</tr>
</thead>
<tbody>
{% set search_lower = (request.args.get('search','')).lower() %}
{% for r in residents if search_lower in r['RefId']|lower or search_lower in r['Name']|lower or search_lower in r['LastName']|lower %}
<tr>
<td>{{ r["RefId"] }}</td>
<td>{{ r["Name"] }}</td>
<td>{{ r["MI"] }}</td>
<td>{{ r["LastName"] }}</td>
<td>{{ r["Birthday"] }}</td>
<td>{{ r["Age"] }}</td>
<td>{{ r["Sex"] }}</td>
<td>{{ r["Address"] }}</td>
<td>{{ r["CivilStatus"] }}</td>
<td>{{ r["Occupation"] }}</td>
<td>{{ r["Nationality"] }}</td>
<td>{{ r["Zone"] }}</td>
<td class="actions">
<button class="btn-orange" type="button" onclick="openEditModal('{{ r['RefId'] }}')">Update</button>
<form method="get" action="{{ url_for('admin.delete_resident', ref_id=r['RefId']) }}" onsubmit="return confirm('Are you sure?');" style="display:inline-block;">
<button class="btn-red">Delete</button>
</form>
</td>
</tr>
{% endfor %}
</tbody>
</table>

<!-- Edit Modal -->
<div id="editModal" class="modal">
<div class="modal-content">
<span class="close" onclick="closeEditModal()">X</span>
<h3>Edit Resident</h3>
<form id="editForm" method="post" class="form-grid">
<input type="text" name="name" id="edit_name" placeholder="Name" required>
<input type="text" name="mi" id="edit_mi" placeholder="Middle Initial">
<input type="text" name="lname" id="edit_lname" placeholder="Last Name">
<input type="text" name="zone" id="edit_zone" placeholder="Zone" required>
<input type="date" name="birthday" id="edit_birthday" placeholder="Birthday">
<input type="number" name="age" id="edit_age" placeholder="Age">
<select name="sex" id="edit_sex" required>
<option value="" disabled>Select Sex</option>
<option value="Male">Male</option>
<option value="Female">Female</option>
</select>
<input type="text" name="address" id="edit_address" placeholder="Address">
<select name="civil_status" id="edit_civil_status">
<option value="" disabled>Select Civil Status</option>
<option value="Single">Single</option>
<option value="Married">Married</option>
<option value="Widowed">Widowed</option>
</select>
<input type="text" name="occupation" id="edit_occupation" placeholder="Occupation">
<input type="text" name="nationality" id="edit_nationality" placeholder="Nationality">
<button type="submit" class="btn-orange">Update Resident</button>
</form>
</div>
</div>
{% endif %}

<!-- ================= Manage Households ================= -->
{% if active_page=='households' %}
<h1>Manage Households</h1>

<div class="box">
<form method="post" action="{{ url_for('admin.create_household') }}">
<label>Next Household ID</label>
<input type="text" name="hh_id" value="HH{{ households|length + 1 }}" readonly>
<label>Select Members:</label>
<select name="members[]" multiple required>
{% for r in residents %}
<option value="{{ r['RefId'] }}">{{ r['Name'] }}{% if r['MI'] %} {{ r['MI'][0] }}.{% endif %} {{ r['LastName'] }}</option>
{% endfor %}
</select>
<button type="submit" class="btn-green">Create Household</button>
</form>
</div>

<div class="search-container">
<form method="get">
<input type="text" name="search_hh" placeholder="Search Household ID" class="search-input" value="{{ request.args.get('search_hh','') }}">
<button type="submit" class="search-btn">Search</button>
</form>
</div>

<table>
<thead>
<tr>
<th>Household ID</th><th>Members</th><th>Add Members</th><th>Delete</th>
</tr>
</thead>
<tbody>
{% for hh_id, members in households.items() %}
<tr>
<td>{{ hh_id }}</td>
<td>{{ members|join(', ') }}</td>
<td>
<form method="post" action="{{ url_for('admin.add_members', hh_id=hh_id) }}">
{% set available_residents = [] %}
{% for r in residents %}{% if r['RefId'] not in members %}{% set _ = available_residents.append(r) %}{% endif %}{% endfor %}
<select name="new_members" {% if available_residents|length > 1 %}multiple{% endif %} required>
{% if available_residents %}
<option value="" disabled selected hidden>Select Resident</option>
{% for r in available_residents %}
<option value="{{ r['RefId'] }}">{{ r['Name'] }}{% if r['MI'] %} {{ r['MI'][0] }}.{% endif %} {{ r['LastName'] }}</option>
{% endfor %}
{% else %}
<option value="" disabled selected>No Available Resident</option>
{% endif %}
</select>
<button type="submit" class="btn-green" {% if not available_residents %}disabled{% endif %}>Add</button>
</form>
</td>
<td>
<form method="post" action="{{ url_for('admin.delete_household', hh_id=hh_id) }}" onsubmit="return confirm('Delete household {{ hh_id }}?');">
<button class="btn-red">Delete</button>
</form>
</td>
</tr>
{% endfor %}
</tbody>
</table>
{% endif %}

<!-- ================= Settings / Account & Logo Settings ================= -->
{% if active_page=='settings' %}
<h1>Settings</h1>
<div class="settings-container">
  <div class="settings-box">
    <h2>Account & Logo Settings</h2>
    <form method="post" enctype="multipart/form-data">
      <label>Change Username:</label>
      <input type="text" name="username" placeholder="Enter new username">
      <label>Change Password:</label>
      <input type="password" name="password" placeholder="Enter new password">
      <label>Confirm Password:</label>
      <input type="password" name="confirm_password" placeholder="Confirm new password">
      <label>Upload New Logo:</label>
      <div class="logo-preview">
        <img src="{{ url_for('static', filename='barangaypic.png') }}" alt="Logo Preview">
      </div>
      <input type="file" name="logo">
      <button type="submit" class="btn-green">Update Settings</button>
    </form>
  </div>

  <div class="settings-box">
    <h2>System Overview</h2>
    <ul>
      <li><strong>Version:</strong> {{ system_info.version }}</li>
      <li><strong>Developer:</strong> {{ system_info.developer }}</li>
      <li><strong>Database:</strong> {{ system_info.database }}</li>
      <li><strong>Framework:</strong> {{ system_info.framework }}</li>
      <li><strong>Last Update:</strong> {{ system_info.last_update }}</li>
    </ul>
    <p>This Barangay Profiling System helps efficiently manage residents and households, providing quick access to population data, household information, and administrative tools for better governance.</p>
  </div>
</div>
{% endif %}

</div>

<script>
let residents = {{ residents|tojson | safe }};

// ---------------- Edit Modal ----------------
function openEditModal(refId) {
    const resident = residents.find(r => r['RefId'] === refId);
    if(!resident) return;
    document.getElementById('edit_name').value = resident['Name'];
    document.getElementById('edit_mi').value = resident['MI'];
    document.getElementById('edit_lname').value = resident['LastName'];
    document.getElementById('edit_zone').value = resident['Zone'];
    document.getElementById('edit_birthday').value = resident['Birthday'];
    document.getElementById('edit_age').value = resident['Age'];
    document.getElementById('edit_sex').value = resident['Sex'];
    document.getElementById('edit_address').value = resident['Address'];
    document.getElementById('edit_civil_status').value = resident['CivilStatus'];
    document.getElementById('edit_occupation').value = resident['Occupation'];
    document.getElementById('edit_nationality').value = resident['Nationality'];
    document.getElementById('editForm').action = `/admin/update_resident/${refId}`;
    document.getElementById('editModal').style.display='flex';
}
function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
    document.getElementById('editForm').reset();
}
</script>

</body>
</html>
